rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // === USERS ===
    match /users/{userId} {
      // Boleh baca data sendiri
      allow read: if request.auth != null && request.auth.uid == userId;

      // Boleh buat data sendiri, tapi hanya bisa set role = "client"
      allow create: if request.auth != null
                    && request.auth.uid == userId
                    && request.resource.data.role == "client";

      // Boleh update data sendiri, tapi tidak boleh mengubah role
      allow update: if request.auth != null
                    && request.auth.uid == userId
                    && !("role" in request.resource.data.keys());

      // Admin boleh full akses
      allow read, write: if request.auth != null && request.auth.token.admin == true;
    }

    // === PEMESANAN ===
    match /pemesanan/{docId} {
      allow read: if request.auth != null && (
        resource.data.uid == request.auth.uid || // user hanya bisa baca pesanannya sendiri
        request.auth.token.admin == true         // admin bisa baca semua
      );
      allow create: if request.auth != null && request.resource.data.uid == request.auth.uid;
      allow update, delete: if request.auth.token.admin == true;
    }

    // === MOBIL ===
    match /mobil/{mobilId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && (
        // User hanya boleh update status saat menyewa
        (request.resource.data.status == "disewa" && request.resource.data.tersedia == false) ||
        // Admin punya akses penuh
        (request.auth.token.admin == true)
      );
    }

    // === NOTIFICATIONS ===
    match /notifications/{notifId} {
      allow read: if request.auth != null && resource.data.userId == request.auth.uid;
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow update: if request.auth != null && resource.data.userId == request.auth.uid;
      // Admin can create notifications for users
      allow create, update: if request.auth != null && request.auth.token.admin == true;
    }

  }
}
